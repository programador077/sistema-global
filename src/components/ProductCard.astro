---
interface Props {
    product: {
        id: string;
        name: string;
        price: number;
        originalPrice?: number | null;
        images: string[];
        category: string;
        rating: number;
        reviews: number;
    };
}

const { product } = Astro.props;
const discount = product.originalPrice
    ? Math.round(
          ((product.originalPrice - product.price) / product.originalPrice) *
              100,
      )
    : 0;
---

<article class="product-card">
    <a href={`/products/${product.id}`} class="product-card__link">
        <div class="product-card__image-wrapper">
            <img
                src={product.images[0]}
                alt={product.name}
                class="product-card__image"
                loading="lazy"
            />
            {
                discount > 0 && (
                    <span class="product-card__badge">-{discount}%</span>
                )
            }
            <button class="quick-view-btn" aria-label="Vista rápida">
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </button>
        </div>

        <div class="product-card__content">
            <span class="product-card__category">{product.category}</span>
            <h3 class="product-card__title">{product.name}</h3>

            <div class="product-card__rating">
                <div class="stars">
                    {
                        Array.from({ length: 5 }, (_, i) => (
                            <span
                                class={
                                    i < Math.floor(product.rating)
                                        ? "star star--filled"
                                        : "star"
                                }
                            >
                                ★
                            </span>
                        ))
                    }
                </div>
                <span class="reviews-count">({product.reviews})</span>
            </div>

            <div class="product-card__price">
                <span class="price-current">${product.price.toFixed(2)}</span>
                {
                    product.originalPrice && (
                        <span class="price-original">
                            ${product.originalPrice.toFixed(2)}
                        </span>
                    )
                }
            </div>
        </div>
    </a>

    <button
        class="add-to-cart-btn"
        data-product-id={product.id}
        data-product-name={product.name}
        data-product-price={product.price}
        data-product-image={product.images[0]}
    >
        <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
        >
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path
                d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
            ></path>
        </svg>
        <span>Agregar</span>
    </button>
</article>

<style>
    .product-card {
        position: relative;
        background: var(--color-bg-secondary);
        border-radius: var(--radius-xl);
        border: 1px solid var(--color-border);
        overflow: hidden;
        transition: all var(--transition-base);
    }

    .product-card:hover {
        border-color: var(--color-border-light);
        box-shadow: var(--shadow-xl);
        transform: translateY(-4px);
    }

    .product-card__link {
        display: block;
        text-decoration: none;
        color: inherit;
    }

    .product-card__image-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        overflow: hidden;
        background: var(--color-bg-tertiary);
    }

    .product-card__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform var(--transition-slow);
    }

    .product-card:hover .product-card__image {
        transform: scale(1.1);
    }

    .product-card__badge {
        position: absolute;
        top: var(--space-md);
        right: var(--space-md);
        background: var(--gradient-primary);
        color: var(--color-text-primary);
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-full);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        box-shadow: var(--shadow-md);
    }

    .quick-view-btn {
        position: absolute;
        top: var(--space-md);
        left: var(--space-md);
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        border: 1px solid var(--glass-border);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: scale(0.8);
        transition: all var(--transition-base);
    }

    .product-card:hover .quick-view-btn {
        opacity: 1;
        transform: scale(1);
    }

    .quick-view-btn:hover {
        background: var(--color-bg-elevated);
        transform: scale(1.1);
    }

    .product-card__content {
        padding: var(--space-lg);
    }

    .product-card__category {
        display: inline-block;
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-xs);
    }

    .product-card__title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-sm);
        line-height: var(--line-height-tight);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-card__rating {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-md);
    }

    .stars {
        display: flex;
        gap: 2px;
    }

    .star {
        color: var(--color-border);
        font-size: var(--font-size-base);
    }

    .star--filled {
        color: hsl(45, 100%, 51%);
    }

    .reviews-count {
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
    }

    .product-card__price {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
    }

    .price-current {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
    }

    .price-original {
        font-size: var(--font-size-base);
        color: var(--color-text-tertiary);
        text-decoration: line-through;
    }

    .add-to-cart-btn {
        width: 100%;
        padding: var(--space-md);
        background: var(--gradient-primary);
        color: var(--color-text-primary);
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        font-weight: var(--font-weight-semibold);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .add-to-cart-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition:
            width 0.6s,
            height 0.6s;
    }

    .add-to-cart-btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .add-to-cart-btn:hover {
        box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .add-to-cart-btn:active {
        transform: scale(0.98);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const addToCartButtons = document.querySelectorAll(".add-to-cart-btn");

        addToCartButtons.forEach((button) => {
            button.addEventListener("click", (e) => {
                e.preventDefault();

                const productData = {
                    id: button.getAttribute("data-product-id"),
                    name: button.getAttribute("data-product-name"),
                    price: parseFloat(
                        button.getAttribute("data-product-price") || "0",
                    ),
                    image: button.getAttribute("data-product-image"),
                    quantity: 1,
                };

                // Get existing cart
                const cart = JSON.parse(localStorage.getItem("cart") || "[]");

                // Check if product already exists
                const existingIndex = cart.findIndex(
                    (item: any) => item.id === productData.id,
                );

                if (existingIndex > -1) {
                    cart[existingIndex].quantity += 1;
                } else {
                    cart.push(productData);
                }

                // Save cart
                localStorage.setItem("cart", JSON.stringify(cart));

                // Dispatch event to update cart count
                window.dispatchEvent(new Event("cartUpdated"));

                // Visual feedback
                const originalText = button.innerHTML;
                button.innerHTML = "<span>✓ Agregado</span>";
                button.style.background = "var(--color-success)";

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = "";
                }, 1500);
            });
        });
    });
</script>
